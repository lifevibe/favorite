name: Build Hugo and Deploy

on:
  push:
    branches:
      - main
  # schedule:
  #  - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      build_content:
        description: "选择构建范围："
        required: true
        default: 'build-favorite'
        type: choice
        options:
          - 'build-favorite'
  repository_dispatch:
    types: [build-favorite]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    env:
      HUGO_CACHEDIR: /tmp/.hugo_cache
      HUGOMODS_CACHEDIR: /tmp/.hugo_mods_cache
      PNPM_CACHEDIR: /tmp/.pnpm-store
      COSCLI_CACHEDIR: /tmp/.coscli-cache

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Cache coscli snapshots
        id: cache-snapshots
        uses: actions/cache@v4
        with:
          path: ${{ env.COSCLI_CACHEDIR }}
          key: ${{ runner.os }}-coscli-cache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-coscli-cache-

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Cache Hugo Resources
        uses: actions/cache@v4
        id: cache-hugo
        with:
          path: |
            resources/_gen
            ${{ env.HUGO_CACHEDIR }}
          key: ${{ runner.os }}-hugo-${{ hashFiles('content/**', 'assets/**', 'layouts/**', 'config.toml', 'pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-hugo-

      - name: Cache Hugo Modules
        uses: actions/cache@v4
        with:
          path: ${{ env.HUGOMODS_CACHEDIR }}
          key: ${{ runner.os }}-hugomod-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-hugomod-

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'

      - name: Fetch Directus links
        run: |
          pnpm install
          pnpm run directus
        env:
          DIRECTUS_API_URL: ${{ secrets.DIRECTUS_API_URL }}
          DIRECTUS_FILES_URL: ${{ secrets.DIRECTUS_FILES_URL }}
          DIRECTUS_ACCESS_TOKEN: ${{ secrets.DIRECTUS_ACCESS_TOKEN  }}

      - name: Build Hugo
        run: |
          hugo --minify

      # - name: Deploy to Aliyun OSS
      #   uses: docker://fangbinwei/aliyun-oss-website-action:v1
      #   env:
      #     ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
      #     ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
      #     BUCKET: s-eallion-com
      #     ENDPOINT: oss-cn-shanghai.aliyuncs.com
      #     FOLDER: public
      #     SKIP_SETTING: true
      #     INCREMENTAL: true

      - name: Download and setup coscli
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/tencentyun/coscli/releases/latest | jq -r '.tag_name')
          FILE_NAME="coscli-${LATEST_VERSION}-linux-amd64"
          DOWNLOAD_URL="https://github.com/tencentyun/coscli/releases/download/${LATEST_VERSION}/${FILE_NAME}"

          echo "Downloading ${DOWNLOAD_URL}..."
          curl -L -o "${FILE_NAME}" "${DOWNLOAD_URL}"

          mv "${FILE_NAME}" /usr/local/bin/coscli
          chmod +x /usr/local/bin/coscli

          coscli config set --secret_id ${{ secrets.COS_SECRET_ID }} --secret_key ${{ secrets.COS_SECRET_KEY }}
          coscli config add --init-skip=true -b ${{ secrets.COS_BUCKET }} -r ap-shanghai -e cos.ap-shanghai.myqcloud.com

      - name: Configure and Sync COS with snapshot
        run: |
          coscli sync ./public/ cos://${{ secrets.COS_BUCKET }} -r --snapshot-path=${{ env.COSCLI_CACHEDIR }}

      - name: Purge Cache
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }} 
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          TEO_SITE_ID: ${{ secrets.TEO_SITE_ID }}
        run: |
          node scripts/purge_teo_cache.js